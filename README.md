# üìñ README
# –ù–∞—à –ø–æ–¥—Ö–æ–¥ –∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–≠—Ç–æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º –ø–∏—Å–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –±–µ–∑ –ª–∏—à–Ω–µ–π —Ä—É—Ç–∏–Ω—ã. –û–Ω –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **Spring Boot** –∏ —á–∏—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ –µ–¥–∏–Ω—ã—Ö JSON-—Ñ–∞–π–ª–æ–≤.
–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å `-Denv=<–∏–º—è>` ‚Äî –∏ –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è API, –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö, Redis, Kafka –∏ NATS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞—Ç—Å—è –∫ –Ω—É–∂–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º.

–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ —Ö—Ä–∞–Ω—è—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã, –ø–æ—ç—Ç–æ–º—É —Ç–µ—Å—Ç—ã –º–æ–∂–Ω–æ —Å–º–µ–ª–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ. –ë–ª–∞–≥–æ–¥–∞—Ä—è DI —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º–∏ –∏ —Ö–æ—Ä–æ—à–æ —á–∏—Ç–∞–µ–º—ã–º–∏.
* **–ï–¥–∏–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è.** `DynamicPropertiesConfigurator` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  –∏–∑ json –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö –≤ Spring, –ø–æ—ç—Ç–æ–º—É —Ç–µ—Å—Ç—ã –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –º–µ–∂–¥—É –æ–∫—Ä—É–∂–µ–Ω–∏—è–º–∏
  –±–µ–∑ –ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞.
* **–ù–∞–±–æ—Ä —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.** –î–ª—è HTTP, Kafka, NATS, Redis –∏ MySQL
  –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å –æ–∂–∏–¥–∞–Ω–∏—è–º–∏, —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –∞—Ç—Ç–∞—á–∞–º–∏ –≤ Allure.
* **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—á—ë—Ç—ã.** HTTP‚Äë–∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
  `AllureFeignLogger`, —Å–æ–±—ã—Ç–∏—è –∏–∑ Kafka –∏ NATS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –∫ –æ—Ç—á—ë—Ç—É,
  –∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å Redis –∏ –ë–î —Å–Ω–∞–±–∂–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏.
* **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞—Ç—Ç–∞—á–µ–π.** –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `AllureAttachmentService`
  —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º `AttachmentType`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–µ
  –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞—Ç—Ç–∞—á–µ–π –≤–æ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö –æ—Ç—á—ë—Ç–∞.
* **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.** –ö–ª–∏–µ–Ω—Ç—ã Kafka –∏ NATS —É–º–µ—é—Ç –∂–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
  —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ —Ä–µ—Ç—Ä–∞—è–º–∏, —á—Ç–æ –æ–±–ª–µ–≥—á–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –±–∏–∑–Ω–µ—Å‚Äë–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
* **–ì–∏–±–∫–∞—è –∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.** –§—Ä–µ–π–º–≤–æ—Ä–∫ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø–∏—Å–∞—Ç—å
  –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –∏ —É–∫–∞–∑–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
* **–í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.** –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ —Ö—Ä–∞–Ω—è—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —á—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤.

–ú—ã –≤–Ω–µ–¥—Ä—è–µ–º —ç—Ç–æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫, —á—Ç–æ–±—ã –≤—ã–ø—É—Å–∫–∞—Ç—å –Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å—Ä–∞–∑—É —Å –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏ –∏ –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥. –†–∞–Ω–µ–µ –º—ã –≤–µ–ª–∏ —Ä—É–∫–æ–ø–∏—Å–Ω—ã–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã, –∞ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ —Å–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º—ã–π –∫–æ–¥ –∏ –æ—Ç—á—ë—Ç—ã Allure.

–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å **–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∏ –ø–æ–Ω—è—Ç–Ω—É—é** —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É,
—Å–ø–æ—Å–æ–±–Ω—É—é –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

*   [üåê –†–∞–±–æ—Ç–∞ —Å HTTP](#—Ä–∞–±–æ—Ç–∞-—Å-http)
    *   [1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å HTTP](#1-–∫–∞–∫-—É—Å—Ç—Ä–æ–µ–Ω–∞-—Ä–∞–±–æ—Ç–∞-—Å-http)
    *   [2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ](#2-–∫–∞–∫-–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ)
    *   [3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –±–∞–∑–æ–≤—ã–π-url](#3-–≥–¥–µ-–ø—Ä–æ–ø–∏—Å–∞—Ç—å-–±–∞–∑–æ–≤—ã–π-url)
    *   [4. –ö–∞–∫ –æ–ø–∏—Å–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç](#4-–∫–∞–∫-–æ–ø–∏—Å–∞—Ç—å-—ç–Ω–¥–ø–æ–∏–Ω—Ç)
    *   [5. –ü—Ä–∏–º–µ—Ä DTO](#5-–ø—Ä–∏–º–µ—Ä-dto)
    *   [6. –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞](#6-–ø—Ä–∏–º–µ—Ä-–∫–ª–∏–µ–Ω—Ç–∞)
    *   [7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö](#7-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–≤-—Ç–µ—Å—Ç–∞—Ö)
*   [‚öôÔ∏è –†–∞–±–æ—Ç–∞ —Å Kafka](#—Ä–∞–±–æ—Ç–∞-—Å-kafka)
    *   [1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å Kafka](#1-–∫–∞–∫-—É—Å—Ç—Ä–æ–µ–Ω–∞-—Ä–∞–±–æ—Ç–∞-—Å-kafka)
    *   [2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ](#2-–∫–∞–∫-–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-1)
    *   [3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å –±—Ä–æ–∫–µ—Ä–∞](#3-–≥–¥–µ-–ø—Ä–æ–ø–∏—Å–∞—Ç—å-–∞–¥—Ä–µ—Å-–±—Ä–æ–∫–µ—Ä–∞)
    *   [4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å](#4-–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π-–∫–ª–∞—Å—Å-1)
    *   [5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞](#5-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-–Ω–æ–≤–æ–≥–æ-—Ç–æ–ø–∏–∫–∞)
    *   [6. –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞](#6-–ø—Ä–∏–º–µ—Ä-–∫–ª–∏–µ–Ω—Ç–∞-–¥–ª—è-–Ω–æ–≤–æ–≥–æ-—Ç–æ–ø–∏–∫–∞)
    *   [7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö](#7-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–≤-—Ç–µ—Å—Ç–∞—Ö-1)
*   [‚ö° –†–∞–±–æ—Ç–∞ —Å Redis](#—Ä–∞–±–æ—Ç–∞-—Å-redis)
    *   [1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å Redis](#1-–∫–∞–∫-—É—Å—Ç—Ä–æ–µ–Ω–∞-—Ä–∞–±–æ—Ç–∞-—Å-redis)
    *   [2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ](#2-–∫–∞–∫-–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-2)
    *   [3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞](#3-–≥–¥–µ-–ø—Ä–æ–ø–∏—Å–∞—Ç—å-–∞–¥—Ä–µ—Å-—Å–µ—Ä–≤–µ—Ä–∞)
    *   [4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å](#4-–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π-–∫–ª–∞—Å—Å-2)
    *   [5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞](#5-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-–Ω–æ–≤–æ–≥–æ-–∏–Ω—Å—Ç–∞–Ω—Å–∞)
    *   [6. –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞](#6-–ø—Ä–∏–º–µ—Ä-–∫–ª–∏–µ–Ω—Ç–∞-–¥–ª—è-–Ω–æ–≤–æ–≥–æ-–∏–Ω—Å—Ç–∞–Ω—Å–∞)
    *   [7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö](#7-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–≤-—Ç–µ—Å—Ç–∞—Ö-2)
*   [üóÑÔ∏è –†–∞–±–æ—Ç–∞ —Å –ë–î](#—Ä–∞–±–æ—Ç–∞-—Å-–±–¥)
    *   [1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å –ë–î](#1-–∫–∞–∫-—É—Å—Ç—Ä–æ–µ–Ω–∞-—Ä–∞–±–æ—Ç–∞-—Å-–±–¥)
    *   [2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ](#2-–∫–∞–∫-–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-3)
    *   [3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞](#3-–≥–¥–µ-–ø—Ä–æ–ø–∏—Å–∞—Ç—å-–∞–¥—Ä–µ—Å-—Å–µ—Ä–≤–µ—Ä–∞-1)
    *   [4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å](#4-–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π-–∫–ª–∞—Å—Å-3)
    *   [5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã](#5-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-–Ω–æ–≤–æ–π-–±–∞–∑—ã)
    *   [6. –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞](#6-–ø—Ä–∏–º–µ—Ä-–∫–ª–∏–µ–Ω—Ç–∞-1)
    *   [7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö](#7-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–≤-—Ç–µ—Å—Ç–∞—Ö-3)
*   [üì® –†–∞–±–æ—Ç–∞ —Å NATS](#—Ä–∞–±–æ—Ç–∞-—Å-nats)
    *   [1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å NATS](#1-–∫–∞–∫-—É—Å—Ç—Ä–æ–µ–Ω–∞-—Ä–∞–±–æ—Ç–∞-—Å-nats)
    *   [2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ](#2-–∫–∞–∫-–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-4)
    *   [3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞](#3-–≥–¥–µ-–ø—Ä–æ–ø–∏—Å–∞—Ç—å-–∞–¥—Ä–µ—Å-—Å–µ—Ä–≤–µ—Ä–∞-2)
    *   [4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç](#4-–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–∫–ª–∏–µ–Ω—Ç)
    *   [5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ subject](#5-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ-–Ω–æ–≤–æ–≥–æ-subject)
    *   [6. –ü—Ä–∏–º–µ—Ä –ø–æ–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è](#6-–ø—Ä–∏–º–µ—Ä-–ø–æ–∏—Å–∫–∞-—Å–æ–æ–±—â–µ–Ω–∏—è)
    *   [7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö](#7-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–≤-—Ç–µ—Å—Ç–∞—Ö-4)
*   [üîó –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç](#—Ç–µ—Å—Ç–æ–≤—ã–π-–∫–æ–Ω—Ç–µ–∫—Å—Ç-–∏-–ø–µ—Ä–µ–¥–∞—á–∞-–¥–∞–Ω–Ω—ã—Ö)
*   [üß™ –°–∫–≤–æ–∑–Ω–æ–π –ø—Ä–∏–º–µ—Ä](#—Å–∫–≤–æ–∑–Ω–æ–π-–ø—Ä–∏–º–µ—Ä)

*(–ü–æ –º–µ—Ä–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–µ–∫—Ü–∏–π, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ)*

---


## –†–∞–±–æ—Ç–∞ —Å HTTP

### 1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å HTTP

–í –æ—Å–Ω–æ–≤–µ –ª–µ–∂–∞—Ç Feign-–∫–ª–∏–µ–Ω—Ç—ã, –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏ Spring MVC.
–í—Å–µ —Ç–∞–∫–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ –±–∏–Ω—ã —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤
–∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ—Å—Ç–æ–≤. –ó–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç–≤–µ—á–∞–µ—Ç –∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
`HttpApiAutoConfiguration`, –ø–æ—ç—Ç–æ–º—É –∫–∞–∂–¥–∞—è HTTP‚Äë–æ–ø–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—Ç—á—ë—Ç Allure –≤–º–µ—Å—Ç–µ —Å —Ç–µ–ª–æ–º –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.

### 2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤ —É–∫–∞–∂–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ `-Denv=<–∏–º—è_–æ–∫—Ä—É–∂–µ–Ω–∏—è>`.
–ù—É–∂–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `configs`. –í —Ä–∞–∑–¥–µ–ª–µ `http`
–æ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–±–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∞–¥—Ä–µ—Å–∞–º–∏. –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ
–∑–Ω–∞—á–µ–Ω–∏—è, —Ç–∞–∫–∏–µ –∫–∞–∫ —Å–µ–∫—Ä–µ—Ç—ã –∏ –ª–æ–≥–∏–Ω—ã, –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ —Å–µ–∫—Ü–∏—é `walletTests.http`.
–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è —Ä–µ–∞–ª–∏–∑—É–µ—Ç `EnvironmentConfigPostProcessor` –∏
–Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö –±–∞–∑–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É–∂–µ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫
`kafka-api` –∑–∞–≥—Ä—É–∑–∏–ª –æ–∫—Ä—É–∂–µ–Ω–∏–µ. –ö–ª–∞—Å—Å `DynamicPropertiesConfigurator`
—á–∏—Ç–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏–π,
–ø—É–±–ª–∏–∫—É–µ—Ç –∏—Ö –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ `app.http.*` –∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–µ–∂–Ω–∏–µ –∞–ª–∏–∞—Å—ã
`app.api.*` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
—Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –≤ `walletTests.platform` –∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–µ–º –∂–µ –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º,
–ø–æ—Å–ª–µ —á–µ–≥–æ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `EnvironmentConfig#getPlatform()`.

### 3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –±–∞–∑–æ–≤—ã–π-url

–í —Ñ–∞–π–ª–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `http.services.manager.base-url`:

```json
"http": {
  "services": {
    "manager": {
      "baseUrl": "https://manager.test.host"
    }
  }
}
```

### 4. –ö–∞–∫ –æ–ø–∏—Å–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç

–°–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –ø–æ–º–µ—Ç—å—Ç–µ –µ–≥–æ `@FeignClient`. –í –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `url` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ
–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `${app.api.manager.base-url}` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç –º–æ–∂–Ω–æ –±—ã–ª–æ
–ø–æ–¥–∫–ª—é—á–∞—Ç—å –∫ —Ä–∞–∑–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏—è–º. –ú–µ—Ç–æ–¥—ã –æ–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏
Spring MVC (`@GetMapping`, `@PostMapping` –∏ –¥—Ä.).

```java
@FeignClient(name = "managerClient", url = "${app.api.manager.base-url}")
public interface ManagerClient {
    @PostMapping("/_core_gas_processing/bet")
    ResponseEntity<GamblingResponseBody> bet(
            @RequestHeader("X-Casino-Id") String casinoId,
            @RequestHeader("Signature") String signature,
            @RequestBody BetRequestBody request
    );
}
```

### 5. –ü—Ä–∏–º–µ—Ä DTO
–ö–ª–∞—Å—Å—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ñ–æ—Ä–º–ª—è–π—Ç–µ –ø—Ä–∏ –ø–æ–º–æ—â–∏ Lombok, –∞ –æ—Ç–≤–µ—Ç—ã –æ–ø–∏—Å—ã–≤–∞–π—Ç–µ –∫–∞–∫ `record`
‚Äî —Ç–∞–∫ –º—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã –≤–∏–¥–∞ `field()`.

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class BetRequestBody {
    private String     sessionToken;
    private BigDecimal amount;
    private String     transactionId;
    private String     type;
    private String     roundId;
    private Boolean    roundClosed;
}

/**
 * –û—Ç–≤–µ—Ç Manager API –ø–æ—Å–ª–µ —Å—Ç–∞–≤–æ–∫/–≤—ã–∏–≥—Ä—ã—à–µ–π/–≤–æ–∑–≤—Ä–∞—Ç–æ–≤.
 * @param balance –ë–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–∞ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
 * @param transactionId Idempotency UUID, —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –≤ –∑–∞–ø—Ä–æ—Å.
 */
public record GamblingResponseBody(BigDecimal balance, String transactionId) {
}
```

### 6. –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞
–ò–Ω–∂–µ–∫—Ç–∏—Ä—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∞—Å—Å —á–µ—Ä–µ–∑ `@Autowired`.

```java
@Autowired
private ManagerClient managerClient;
```

### 7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö
–û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∫ API –ø—Ä—è–º–æ –≤ —à–∞–≥–µ `Allure.step` –∏ —Å–¥–µ–ª–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:

```java
@Autowired
private ManagerClient managerClient;

step("HTTP: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ Bet", () -> {
    BetRequestBody request = BetRequestBody.builder()
            .sessionToken(sessionToken)
            .amount(new BigDecimal("10.15"))
            .transactionId(transactionId)
            .type("bet")
            .roundId(roundId)
            .roundClosed(false)
            .build();

    ResponseEntity<GamblingResponseBody> response = managerClient.bet(
            casinoId,
            signature,
            request
    );

    // ctx ‚Äî –æ–±—ä–µ–∫—Ç —Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞.
    BigDecimal expectedBalance = ctx.expectedBalanceAfterBet;
    assertAll(
            () -> assertEquals(HttpStatus.OK, response.getStatusCode()),
            () -> assertEquals(transactionId, response.getBody().transactionId()),
            () -> assertEquals(0, expectedBalance.compareTo(response.getBody().balance()))
    );
});
```
## –†–∞–±–æ—Ç–∞ —Å Kafka

### 1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å Kafka

–í —Ç–µ—Å—Ç–æ–≤–æ–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è Kafka —á–∏—Ç–∞—é—Ç—Å—è —Ñ–æ–Ω–æ–≤—ã–º —Å–µ—Ä–≤–∏—Å–æ–º.
–ö–ª–∞—Å—Å `KafkaBackgroundConsumer` –∑–∞–ø—É—Å–∫–∞–µ—Ç `KafkaPollingService`.
`KafkaPollingService` —Å–æ–∑–¥–∞—ë—Ç `KafkaMessageListenerContainer` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ–ø–∏–∫–∞ –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ–≥–æ.
–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ –±—É—Ñ–µ—Ä `MessageBuffer`, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π —Å–æ–±–æ–π –∫–æ–ª—å—Ü–µ–≤—É—é –æ—á–µ—Ä–µ–¥—å.
–ü–æ–∏—Å–∫ –ø–æ –±—É—Ñ–µ—Ä—É –∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –≤—ã–ø–æ–ª–Ω—è–µ—Ç `MessageFinder`, –≤–æ–∑–≤—Ä–∞—â–∞—è —Ç–µ—Å—Ç—É DTO –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

* **KafkaClient** ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π —Ñ–∞—Å–∞–¥. –°–æ–∑–¥–∞—ë—Ç –±–∏–ª–¥–µ—Ä –æ–∂–∏–¥–∞–Ω–∏–π –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –µ–º—É —Ñ–æ–Ω–æ–≤–æ–≥–æ consumer –∏ —Ç–∞–π–º–∞—É—Ç—ã.
* **KafkaExpectationBuilder** ‚Äî fluent-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã, —Ç–∞–π–º–∞—É—Ç, —Ñ–ª–∞–≥ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏.
* **KafkaBackgroundConsumer** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∞–º–∏, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –±—É—Ñ–µ—Ä–µ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å Allure.
* **KafkaPollingService** ‚Äî –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Å–µ—Ä–≤–∏—Å Spring Kafka, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–ø–∏–∫–∏, —Å—Ä–∞–∑—É —Å–º–µ—â–∞–µ—Ç consumer –≤ –∫–æ–Ω–µ—Ü –∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ –±—É—Ñ–µ—Ä.
* **MessageBuffer** ‚Äî –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –±—É—Ñ–µ—Ä –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–æ–ø–∏–∫. –°–ª–µ–¥–∏—Ç –∑–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏ —Ö—Ä–∞–Ω–∏—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π.
* **MessageFinder** ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç JsonPath-—Ñ–∏–ª—å—Ç—Ä—ã, –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ —Å–æ–æ–±—â–∞–µ—Ç –æ–± –æ—à–∏–±–∫–∞—Ö –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

### 2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤ —É–∫–∞–∂–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ `-Denv=<–∏–º—è_–æ–∫—Ä—É–∂–µ–Ω–∏—è>`.
–í –∫–∞—Ç–∞–ª–æ–≥–µ `configs` —Ö—Ä–∞–Ω—è—Ç—Å—è json-—Ñ–∞–π–ª—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π.
–í —Ä–∞–∑–¥–µ–ª–µ `kafka` –∑–∞–¥–∞—é—Ç—Å—è `bootstrapServer`, `groupId` –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ç–∞–π–º-–∞—É—Ç—ã, —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ –∏ —Ç.–ø.).

### 3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å –±—Ä–æ–∫–µ—Ä–∞

–ê–¥—Ä–µ—Å–∞ –±—Ä–æ–∫–µ—Ä–æ–≤ –∏ –Ω–∞–±–æ—Ä –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ–º—ã—Ö —Ç–æ–ø–∏–∫–æ–≤ –∑–∞–¥–∞—é—Ç—Å—è –≤ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ó–Ω–∞—á–µ–Ω–∏—è —á–∏—Ç–∞—é—Ç—Å—è –∫–ª–∞—Å—Å–æ–º `DynamicPropertiesConfigurator` –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ `KafkaConsumerConfig`. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥—ë–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∏–∑ `beta-09.json`:

```json
"kafka": {
  "bootstrapServer": "kafka-development-01.b2bdev.pro:9092,kafka-development-02.b2bdev.pro:9092,kafka-development-03.b2bdev.pro:9092",
  "groupId": "cb-wallet-test-consumer-beta-09"
}
```

### 4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç Kafka

`KafkaClient` –Ω–∞—Å–ª–µ–¥—É–µ—Ç `AbstractKafkaClient` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.
–¢–æ–ø–∏–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `KafkaConsumerConfig`, –≥–¥–µ –∫–∞–∂–¥–æ–º—É –∫–ª–∞—Å—Å—É DTO —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å—É—Ñ—Ñ–∏–∫—Å —Ç–æ–ø–∏–∫–∞.
–ö–ª–∏–µ–Ω—Ç –∏—â–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ `MessageBuffer` –∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –∏—Ö –≤ –Ω—É–∂–Ω—ã–π —Ç–∏–ø.

–û—Å–Ω–æ–≤–Ω–æ–π DSL:
- `expect(Class<T>)` ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.
  –§–∏–ª—å—Ç—Ä—ã –¥–æ–±–∞–≤–ª—è–π—Ç–µ —á–µ—Ä–µ–∑ `.with("key", value)`, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî `.unique()`,
  —Ç–∞–π–º–∞—É—Ç ‚Äî `.within(Duration)` –∏ –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ –æ–∂–∏–¥–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–º `.fetch()`.

### 5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–ø–∏–∫–∞

1. –°–æ–∑–¥–∞–π—Ç–µ DTO –≤ –ø–∞–∫–µ—Ç–µ `api/kafka/dto`.
2. –î–æ–±–∞–≤—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É DTO –∏ —Å—É—Ñ—Ñ–∏–∫—Å–æ–º —Ç–æ–ø–∏–∫–∞ –≤ `KafkaConsumerConfig`:

```java
@Bean
public KafkaTopicMappingRegistry kafkaTopicMappingRegistry() {
    Map<Class<?>, String> mappings = new HashMap<>();
    // —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–ø–∏–∫–∏
    mappings.put(PlayerAccountMessage.class, "player.v1.account");
    mappings.put(WalletProjectionMessage.class, "wallet.v8.projectionSource");
    mappings.put(GameSessionStartMessage.class, "core.gambling.v1.GameSessionStart");
    mappings.put(LimitMessage.class, "limits.v2");
    // –Ω–æ–≤—ã–π —Ç–æ–ø–∏–∫
    mappings.put(BonusAwardMessage.class, "bonus.v1.award");
    return new SimpleKafkaTopicMappingRegistry(mappings);
}
```
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ `MessageBuffer` –Ω–∞—á–Ω—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ª—É—à–∞—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–æ–ø–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–º—É —Ä–µ–µ—Å—Ç—Ä—É.

### 6. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö

–ò–Ω–∂–µ–∫—Ç–∏—Ä—É–π—Ç–µ `KafkaClient` –∏ –æ–∂–∏–¥–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ `Allure.step`:

```java
@Autowired
private KafkaClient kafkaClient;

step("Kafka: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è", () -> {
    var message = kafkaClient.expect(WalletProjectionMessage.class)
            .with("seq_number", testData.someEvent.getSequence())
            .fetch();
    assertTrue(utils.areEquivalent(message, testData.someEvent));
});
```

#### FAQ / Troubleshooting

**–í–æ–ø—Ä–æ—Å:** —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç —Å `KafkaMessageNotFoundException`, —Ö–æ—Ç—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ—á–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?

* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä—ã `.with(...)` —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º payload (–æ—Å–æ–±–µ–Ω–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä –∏ —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–µ–ª).
* –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å—É—Ñ—Ñ–∏–∫—Å —Ç–æ–ø–∏–∫–∞ –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ DTO –¥–æ–±–∞–≤–ª–µ–Ω –≤ `KafkaTopicMappingRegistry`.
* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–µ—Ñ–∏–∫—Å —Ç–æ–ø–∏–∫–∞ (environment prefix) —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –∏–º–µ–Ω–µ–º —Ç–æ–ø–∏–∫–∞.
* –£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç —á–µ—Ä–µ–∑ `.within(...)` –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
* –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Kafka –∏–ª–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

**–í–æ–ø—Ä–æ—Å:** –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—ã–π DTO, –Ω–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Ç–æ–ø–∏–∫.

* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –±–∏–Ω–µ `KafkaTopicMappingRegistry` –¥–æ–±–∞–≤–ª–µ–Ω –º–∞–ø–ø–∏–Ω–≥ `mappings.put(MyNewMessage.class, "my.new.topic.suffix")`. –ë–µ–∑ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –≤—ã—á–∏—Å–ª–∏—Ç—å –ø–æ–ª–Ω–æ–µ –∏–º—è —Ç–æ–ø–∏–∫–∞.

## –†–∞–±–æ—Ç–∞ —Å Redis

### 1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å Redis

–§—Ä–µ–π–º–≤–æ—Ä–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã `GenericRedisClient<T>`
–Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç fluent-API —á–µ—Ä–µ–∑
`RedisExpectationBuilder`, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è:

```java
var aggregate = redisWalletClient
        .key(ctx.registeredPlayer.getWalletData().walletUUID())
        .withAtLeast("LastSeqNumber", (int) ctx.betEvent.getSequence())
        .with("isGamblingActive", true)
        .within(Duration.ofSeconds(10))
        .fetch();
```

–í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–∂–∏–¥–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è Allure-–∞—Ç—Ç–∞—á–∏: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
–æ –ø–æ–∏—Å–∫–µ, –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ª–∏–±–æ –ø—Ä–∏—á–∏–Ω—ã —Ç–∞–π–º–∞—É—Ç–∞, –∞ —Ç–∞–∫–∂–µ –æ—à–∏–±–∫–∏
–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏. JSONPath-—Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∏–∑ –∫–æ—Ä–æ–±–∫–∏.

–í—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (connection factory, `RedisTemplate`, –∫–ª–∏–µ–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Awaitility)
–ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π `RedisApiAutoConfiguration`. –û–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ
–µ—Å–ª–∏ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª `redis.clients`, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º
Redis –Ω–µ –Ω—É–∂–µ–Ω, –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏.

### 2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Å—Ç—ã —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º —Å–≤–æ–π—Å—Ç–≤–æ–º `-Denv=<–∏–º—è_–æ–∫—Ä—É–∂–µ–Ω–∏—è>`. –í –∫–∞—Ç–∞–ª–æ–≥–µ
`configs` —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –≥–¥–µ —Ä–∞–∑–¥–µ–ª `redis` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≤—Ç–æ—Ä–æ–≤
–∏ —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤. –û—Ç–¥–µ–ª—å–Ω—ã–π `application.yml` –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è
–ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏–∑ JSON —á–µ—Ä–µ–∑ `DynamicPropertiesConfigurator`. –ü—Ä–∏–º–µ—Ä –∏–∑ `beta-09.json`:

```json
"redis": {
    "aggregate": {
        "maxGamblingCount": 50,
        "maxIframeCount": 500,
        "retryAttempts": 10,
        "retryDelayMs": 200
    },
    "clients": {
      "wallet": {
        "host": "redis-01.b2bdev.pro",
        "port": 6390,
        "database": 9,
        "timeout": "5000ms",
        "lettucePool": {
          "maxActive": 8,
          "maxIdle": 8,
          "minIdle": 0,
          "shutdownTimeout": "100ms"
        }
      },
      "player": {
        "host": "redis-01.b2bdev.pro",
        "port": 6389,
        "database": 9,
        "timeout": "5000ms",
        "lettucePool": {
          "maxActive": 8,
          "maxIdle": 8,
          "minIdle": 0,
          "shutdownTimeout": "100ms"
        }
      }
    }
}
```

### 3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞

–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ –≤ —Ä–∞–∑–¥–µ–ª–µ
`redis.clients`. `DynamicPropertiesConfigurator` –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –∏—Ö –≤ Spring Environment,
–ø–æ—Å–ª–µ —á–µ–≥–æ –∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ `RedisTemplate`.

### 4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–∂–∏–¥–∞–Ω–∏–µ

`RedisExpectationBuilder` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Awaitility –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ —á—Ç–µ–Ω–∏—è
–∑–Ω–∞—á–µ–Ω–∏—è. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ JSONPath-—Ñ–∏–ª—å—Ç—Ä–æ–≤, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å
—Ç–∞–π–º–∞—É—Ç (`within(...)`) –∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø—Ä–µ–¥–∏–∫–∞—Ç–∞–º–∏. –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏
—Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—é—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ –∞—Ç—Ç–∞—á–∞–º–∏ –≤ Allure, –ø–æ—ç—Ç–æ–º—É –≤ —Ç–µ—Å—Ç–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
–≤—ã–∑–≤–∞—Ç—å `fetch()` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π DTO.

### 5. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–¥–∞–Ω—ã `redis.clients` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω—É–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

2. –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–ª–∞—Å—Å —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –±–∏–Ω–æ–º `RedisTypeMappingRegistry`:

   ```java
   @Configuration
   public class RedisConfig {

       @Bean
       public RedisTypeMappingRegistry redisTypeMappingRegistry() {
           return new RedisTypeMappingRegistry()
                   .register("wallet", new TypeReference<WalletFullData>() {})
                   .register("player", new TypeReference<Map<String, WalletData>>() {});
       }
   }
   ```

   –ö–ª—é—á–∏, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –≤ `register(...)`, –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑
   `redis.clients`.

–ù–∞ —ç—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ê–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∞–º–∞ —Å–æ–∑–¥–∞—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, —à–∞–±–ª–æ–Ω—ã
–∏ `GenericRedisClient`-–±–∏–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.

### 6. –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–ò–Ω–∂–µ–∫—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∞—Å—Å –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–≤—ã—á–Ω–æ:

```java
@Autowired
private GenericRedisClient<WalletFullData> redisWalletClient;
```

–î–∞–ª–µ–µ –º–æ–∂–Ω–æ –≥–∏–±–∫–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –≤ —à–∞–≥–µ:

```java
step("Redis: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≥—Ä–µ–≥–∞—Ç –∫–æ—à–µ–ª—å–∫–∞", () -> {
    var aggregate = redisWalletClient
            .key(testData.walletUuid())
            .with("$.lastSeqNumber", testData.expectedSeq())
            .with("$.isGamblingActive", true)
            .within(Duration.ofSeconds(10))
            .fetch();

    assertThat(aggregate.getWallet().getBalance()).isEqualTo(testData.expectedBalance());
});
```

–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑
–ø–µ—Ä–µ–≥—Ä—É–∑–∫—É `with(jsonPath, predicate)`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç—á–µ—Ä—ã –ª–∏–±–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
–ø–æ–ª–æ–∂–∏—Ç—å—Å—è –Ω–∞ JSONPath-—Ñ–∏–ª—å—Ç—Ä—ã. –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —á—Ç–µ–Ω–∏—è —Å–Ω–∞–±–∂–∞—é—Ç—Å—è Allure-–∞—Ç—Ç–∞—á–∞–º–∏,
–ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏—è—Ö –≤ –æ—Ç—á—ë—Ç–µ –±—É–¥–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ –≤–∏–¥–Ω–æ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏—Å–∫–∞–ª–∏ –∏ —á—Ç–æ
–æ–∫–∞–∑–∞–ª–æ—Å—å –≤ Redis.

## –†–∞–±–æ—Ç–∞ —Å –ë–î

### 1. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å –ë–î

–î–æ—Å—Ç—É–ø –∫ MySQL –æ—Å—É—â–µ—Å—Ç–≤–ª—è—é—Ç –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞ –±–∞–∑–µ Spring Data JPA. –î–ª—è —Ä–∞–∑–Ω—ã—Ö
–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ `DataSource` –∏ `EntityManager`. –ë–∞–∑–æ–≤—ã–π
–∫–ª–∞—Å—Å `AbstractDatabaseClient` —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫—É –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π —Å
–ø–æ–≤—Ç–æ—Ä–∞–º–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∞—Ç—Ç–∞—á–∏ –≤ Allure. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä
`WalletDatabaseClient` –∏ `CoreDatabaseClient`, —Ä–∞—Å—à–∏—Ä—è—é—Ç –µ–≥–æ –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç
—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ Spring.

### 2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Å—Ç—ã —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º —Å–≤–æ–π—Å—Ç–≤–æ–º `-Denv=<–∏–º—è_–æ–∫—Ä—É–∂–µ–Ω–∏—è>`. –í –∫–∞—Ç–∞–ª–æ–≥–µ
`configs` –≤ —Ä–∞–∑–¥–µ–ª–µ `databases` –∑–∞–¥–∞—é—Ç—Å—è –∞–¥—Ä–µ—Å–∞ —Ö–æ—Å—Ç–æ–≤, —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
–æ–∂–∏–¥–∞–Ω–∏—è.

### 3. –ì–¥–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–ª–∞—Å—Å–æ–º `DynamicPropertiesConfigurator` –∏
–ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ `CoreDbConfig` –∏ `WalletDbConfig`, —Å–æ–∑–¥–∞—é—â–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–Ω—ã JPA.

### 4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å

–ú–µ—Ç–æ–¥ `awaitAndGetOrFail` –≤ `AbstractDatabaseClient` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Awaitility –¥–ª—è
–æ–∂–∏–¥–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç—á—ë—Ç.

### 5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã

1. –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–æ–≤–æ–π –±–∞–∑—ã –≤ —Ä–∞–∑–¥–µ–ª `databases` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
2. –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–ª–∞—Å—Å –ø–æ –æ–±—Ä–∞–∑—Ü—É `CoreDbConfig`.
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç, –Ω–∞—Å–ª–µ–¥—É—é—â–∏–π `AbstractDatabaseClient`, –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ
   —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

### 6. –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞

```java
@Component
public class WalletDatabaseClient extends AbstractDatabaseClient {

    private final WalletRepository walletRepository;

    public WalletDatabaseClient(AllureAttachmentService attachmentService,
                                WalletRepository walletRepository,
                                ObjectMapper objectMapper) {
        super(attachmentService, objectMapper);
        this.walletRepository = walletRepository;
    }

    @Transactional(readOnly = true)
    public Wallet findWalletByUuidOrFail(String uuid) {
        Supplier<Optional<Wallet>> query = () ->
                Optional.ofNullable(walletRepository.findByUuid(uuid));
        return awaitAndGetOrFail("wallet by uuid " + uuid,
                "Wallet Record [" + uuid + "]", query);
    }
}
```

### 7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö

```java
@Autowired
private WalletDatabaseClient walletDatabaseClient;

step("DB: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å—å –∫–æ—à–µ–ª—å–∫–∞", () -> {
    var wallet = walletDatabaseClient.findWalletByUuidOrFail(testData.walletUuid);
    assertNotNull(wallet);
});
```

## –†–∞–±–æ—Ç–∞ —Å NATS

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–¥—Ö–æ–¥ Kafka-–∫–ª–∏–µ–Ω—Ç–∞. `NatsConnectionManager` –ø–æ–¥–Ω–∏–º–∞–µ—Ç
—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω—É–∂–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞. –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ `Connection` –∏
`JetStream` –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ `NatsSubscriber`, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É,
–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ Allure-–∞—Ç—Ç–∞—á–µ–π. –í–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
`NatsPayloadMatcher`: –æ–Ω –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç payload –≤ `Map`, –ø—Ä–∏–º–µ–Ω—è–µ—Ç JSONPath-—Ñ–∏–ª—å—Ç—Ä—ã
–∏ –æ—Ç–¥–∞—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏. –°–µ—Ä–≤–∏—Å `NatsAttachmentHelper`
—Å–æ–∑–¥–∞—ë—Ç –¥–≤–∞ —Ç–∏–ø–∞ –∞—Ç—Ç–∞—á–µ–π ‚Äî Search Info —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–∏—Å–∫–∞ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
—Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö —ç—Ç–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω —Ñ–∞—Å–∞–¥ `NatsClient` —Å fluent-API
–æ–∂–∏–¥–∞–Ω–∏–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ç–∞–π–º–∞—É—Ç–æ–≤.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ `-Denv=<–∏–º—è_–æ–∫—Ä—É–∂–µ–Ω–∏—è>`. –í —Ñ–∞–π–ª–µ
`configs/<env>.json` –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–∫—Ü–∏—è `nats` —Å —Ö–æ—Å—Ç–∞–º–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
–ø–æ–¥–ø–∏—Å–æ–∫. –ü—Ä–∏–º–µ—Ä:

```json
"nats": {
  "hosts": ["nats-01.dev.local:4222", "nats-02.dev.local:4222"],
  "streamName": "wallet",
  "streamPrefix": "beta-09",
  "searchTimeoutSeconds": 60,
  "uniqueDuplicateWindowMs": 5000,
  "subscriptionAckWaitSeconds": 10,
  "subscriptionInactiveThresholdSeconds": 30,
  "subscriptionBufferSize": 200,
  "subscriptionRetryCount": 5,
  "subscriptionRetryDelayMs": 500
}
```

`NatsConfigProvider` —Å—á–∏—Ç—ã–≤–∞–µ—Ç —ç—Ç—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –µ—ë –≤ `NatsConnectionManager`,
–ø–æ—ç—Ç–æ–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π `application.yml` –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

### 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ subject

`NatsClient` –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å –≥–æ—Ç–æ–≤—ã–º helper-–æ–º `buildWalletSubject(playerUuid, walletUuid)`,
–∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä–æ–∏—Ç subject –≤–∏–¥–∞ `prefix.streamName.*.<playerUuid>.<walletUuid>`.
–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–±—Ä–∏–∫–∏ subject –≤ —Å–∞–º–æ–º –∫–ª–∏–µ–Ω—Ç–µ
–∏–ª–∏ —É–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `.from("<subject>")`.

### 4. Fluent API –æ–∂–∏–¥–∞–Ω–∏–π

`NatsExpectationBuilder` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ—Ç –∂–µ DSL, —á—Ç–æ –∏ Kafka-–∫–ª–∏–µ–Ω—Ç:

* `.from(subject)` ‚Äî –∑–∞–¥–∞—ë—Ç JetStream-subject.
* `.with(jsonPath, expectedValue)` ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç payload –ø–æ JSONPath. –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è
  –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ —Å—Ç—Ä–æ–∫–µ, –ø–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ —Å–º–µ–ª–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–∏—Å–ª–∞ –∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è.
* `.withType(typeHeader)` –∏ `.withSequence(seq)` ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É `type` –∏
  –Ω–æ–º–µ—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å—Ç—Ä–∏–º–µ.
* `.unique([window])` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–∞–π–¥–µ–Ω–æ —Ä–æ–≤–Ω–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –¥–æ–∂–∏–¥–∞—è—Å—å
  –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–∫–Ω–∞.
* `.within(timeout)` ‚Äî –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∞–π–º–∞—É—Ç –ø–æ–∏—Å–∫–∞.

–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ NATS-–∫–ª–∏–µ–Ω—Ç–µ –∑–∞–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JSONPath –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ. –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥
–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Search Info –∏ —É–ø—Ä–æ—â–∞–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –±–µ–∑
–∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤; –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `.with(BiPredicate)` –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞.

### 5. –ê—Ç—Ç–∞—á–∏ Allure

–ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ `.fetch()` –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—Ç—á—ë—Ç:

* **Search Info** —Å subject, —Ç–∞–π–º–∞—É—Ç–æ–º, —Ç–∏–ø–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–µ—Ä–µ—á–Ω–µ–º –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
  (JSONPath –∏ –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º).
* **Found Message** ‚Äî —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
* **Duplicate Message** –ª–∏–±–æ **Message Not Found**, –µ—Å–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å
  –Ω–µ—É—Å–ø–µ—à–Ω–æ.

### 6. –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä

```java
step("NATS: –æ–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞", () -> {
    String subject = natsClient.buildWalletSubject(playerId, walletId);

    NatsMessage<NatsBalanceAdjustedPayload> event = natsClient
            .expect(NatsBalanceAdjustedPayload.class)
            .from(subject)
            .withType(NatsEventType.BALANCE_ADJUSTED.getHeaderValue())
            .with("$.comment", expectedComment)
            .fetch();

    assertEquals(walletId, event.getPayload().getUuid());
});
```

#### –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø—Ä–∏–º–µ—Ä

```java
step("NATS: –û–∂–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Ç–∏–ø–æ–º", () -> {
    String subject = natsClient.buildWalletSubject(playerId, walletId);

    NatsMessage<WalletLimitEvent> message = natsClient.expect(WalletLimitEvent.class)
            .from(subject)
            .withType("LimitCreatedEvent")
            .with("$.limitType", "DAILY_TRANSACTION")
            .with("$.newAmount", 10000)
            .unique()
            .fetch();

    assertNotNull(message.getPayload(), "then.nats.payload_not_null");
    assertEquals("LimitCreatedEvent", message.getType(), "then.nats.type_header.match");
});
```

–§–∏–ª—å—Ç—Ä—ã –º–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ: –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å `.withSequence(...)`
–¥–ª—è –∂—ë—Å—Ç–∫–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ JSONPath-–ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ–¥—Ä—è–¥.

### 7. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–æ–≤–æ–º—É subject

1. –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Å–µ–∫—Ü–∏—é `nats` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ helper –≤ `NatsClient`, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç subject —Å–ª–æ–∂–Ω—ã–π.
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.from("<subject>")` –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —à–∞–≥–∞ –≤ —Ç–µ—Å—Ç–µ.

### 8. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö

–ò–Ω–∂–µ–∫—Ç–∏—Ä—É–π—Ç–µ `NatsClient` –∫–∞–∫ –ª—é–±–æ–π Spring-–±–∏–Ω –∏ –≤—ã–∑—ã–≤–∞–π—Ç–µ –µ–≥–æ –≤–Ω—É—Ç—Ä–∏ `Allure.step`:

```java
@Autowired
private NatsClient natsClient;

step("NATS: –ø–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏", () -> {
    natsClient.expect(NatsBettingEventPayload.class)
            .from(subject)
            .withType(NatsEventType.BETTED_FROM_IFRAME.getHeaderValue())
            .with("$.betUuid", expectedBetUuid)
            .fetch();
});
```

–¢–∞–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É Kafka –∏ NATS-–∫–ª–∏–µ–Ω—Ç–∞–º–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–µ—Å—à–æ–≤–Ω—ã–º:
–≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –æ—Ç—á—ë—Ç–∞.
## üîó –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö

–í–Ω—É—Ç—Ä–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ –∫–ª–∞—Å—Å—ã `TestContext`, –∫—É–¥–∞
—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —à–∞–≥–∞—Ö. –≠–∫–∑–µ–º–ø–ª—è—Ä —Ç–∞–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞
—Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Ç–µ—Å—Ç–∞ –∏ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –ª—è–º–±–¥—ã `Allure.step`.

```java
final class TestContext {
    RegisteredPlayerData registeredPlayer;
    MakePaymentRequest betRequest;
    NatsMessage<NatsBettingEventPayload> winEvent;
}

final TestContext ctx = new TestContext();

step("Default Step: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", () -> {
    ctx.registeredPlayer = defaultTestSteps.registerNewPlayer(BigDecimal.ZERO);
});

step("Manager API: —Å—Ç–∞–≤–∫–∞", () -> {
    ctx.betRequest = generateRequest(ctx.registeredPlayer.getWalletData().walletUUID());
    managerClient.makePayment(ctx.betRequest);
});
```

–¢–∞–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–µ–ª–∞–µ—Ç –∫–æ–¥ —Ç–µ—Å—Ç–∞ —Å–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º—ã–º –∏ —É–ø—Ä–æ—â–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö
–º–µ–∂–¥—É —à–∞–≥–∞–º–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

## üß™ –°–∫–≤–æ–∑–Ω–æ–π –ø—Ä–∏–º–µ—Ä

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥—ë–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ—Å—Ç–∞ `WinFromIframeTest.shouldProcessWinFromIframeAndVerifyEvent`,
–∫–æ—Ç–æ—Ä—ã–π –∑–∞–¥–µ–π—Å—Ç–≤—É–µ—Ç HTTP‚Äë–∫–ª–∏–µ–Ω—Ç, NATS, Kafka, –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ Redis.

```java
@Test
@DisplayName("–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–∏–≥—Ä—ã—à–∞ iframe")
void shouldProcessWinFromIframeAndVerifyEvent() {
    final BigDecimal adjustmentAmount = new BigDecimal("150.00");
    final BigDecimal betAmount = new BigDecimal("10.15");
    final BigDecimal winAmount = new BigDecimal("20.15");
    final class TestContext {
        RegisteredPlayerData registeredPlayer;
        MakePaymentData betInputData;
        MakePaymentRequest betRequestBody;
        NatsMessage<NatsBettingEventPayload> winEvent;
    }
    final TestContext ctx = new TestContext();

    step("Default Step: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", () -> {
        ctx.registeredPlayer = defaultTestSteps.registerNewPlayer(adjustmentAmount);
    });

    step("Manager API: –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ —Å–ø–æ—Ä—Ç", () -> {
        ctx.betInputData = MakePaymentData.builder()
                .type(NatsBettingTransactionOperation.BET)
                .playerId(ctx.registeredPlayer.getWalletData().playerUUID())
                .summ(betAmount.toPlainString())
                .couponType(NatsBettingCouponType.SINGLE)
                .currency(ctx.registeredPlayer.getWalletData().currency())
                .build();

        ctx.betRequestBody = generateRequest(ctx.betInputData);
        managerClient.makePayment(ctx.betRequestBody);
    });

    step("Manager API: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∞", () -> {
        ctx.betRequestBody.setSumm(winAmount.toString());
        ctx.betRequestBody.setType(NatsBettingTransactionOperation.WIN);
        managerClient.makePayment(ctx.betRequestBody);
    });

    step("NATS: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏—è", () -> {
        var subject = natsClient.buildWalletSubject(
                ctx.registeredPlayer.getWalletData().playerUUID(),
                ctx.registeredPlayer.getWalletData().walletUUID());
        ctx.winEvent = natsClient.expect(NatsBettingEventPayload.class)
                .from(subject)
                .fetch();
    });

    step("Kafka: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è", () -> {
        walletProjectionKafkaClient.expect(WalletProjectionMessage.class)
                .with("seq_number", ctx.winEvent.getSequence())
                .fetch();
    });

    step("DB Wallet: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏", () -> {
        walletDatabaseClient.findLatestIframeHistoryByUuidOrFail(
                ctx.winEvent.getPayload().getUuid());
    });

    step("Redis(Wallet): –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≥—Ä–µ–≥–∞—Ç–∞", () -> {
        redisWalletClient
                .key(ctx.registeredPlayer.getWalletData().walletUUID())
                .withAtLeast("LastSeqNumber", (int) ctx.winEvent.getSequence())
                .fetch();
    });
}
```
